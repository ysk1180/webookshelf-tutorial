$(function(){
  function search(keyword){
    if (globalTimeout != null) {
      clearTimeout(globalTimeout);
    }
    globalTimeout = setTimeout(function() {
      globalTimeout = null;
      // キーワードに入力がないときは検索しないようにする
      if (keyword === ''){
        $(`#display`).css('display','none');
        return false
      };
      $.ajax({
        url: '/search',
        type: 'GET',
        dataType: 'json',
        async: true,
        data: {keyword: keyword},
      }).done(function(data){
        $(`#display`).css('display', '');
        $(`#display`).html(data.content);
      });
    }, 700); // 何ms後に検索するか
  }

  // 入力後一定時間が過ぎた後にajax処理
  var globalTimeout = null;
  $('#keyword').keyup(function() {
    var keyword = $("#keyword").val();
    search(keyword);
  });

  // 画像生成
  $("#save-button").on("click", function () {
    // 処理前に Loading 画像を表示
    dispLoading('シェア準備中');

    // 生成する文字列の長さ
    var l = 8;
    // 生成する文字列に含める文字セット
    var c = "abcdefghijklmnopqrstuvwxyz0123456789";
    var cl = c.length;
    var hash = "";
    for(var i=0; i<l; i++){
      hash += c[Math.floor(Math.random()*cl)];
    }

    html2canvas($('.preview').get(0), {
      proxy: true,
      useCORS: true
    }).then( function (canvas) {
      var imgData = canvas.toDataURL();

      $.ajax({
        url: '/make',
        type: 'POST',
        dataType: 'json',
        async: true,
        data: {imgData: imgData, hash: hash},
      }).done(function(data){
        removeLoading();
        Swal.fire({
          type: 'success',
          text: '↓Let\' share',
          imageUrl: `https://s3-ap-northeast-1.amazonaws.com/webookshelf-tutorial-production/images/${hash}.png`,
          imageWidth: 315,
          imageAlt: 'Custom image',
          showConfirmButton: false,
          showCloseButton: true,
          footer: `<div class=modal-twitter><a href=https://twitter.com/share?text=%23映画シェア&url=https://webookshelf-tutorial.herokuapp.com?h=${hash} class=modal_btn>Twitterシェア</a>`,
        })
      }).fail( function(data) {
        removeLoading();
        Swal.fire({
          type: 'error',
          title: '画像作成に失敗しました...(; ;)',
          text: 'もう一度ボタンを押してみてください(> <)',
        })
      });
    });
  });

/* ------------------------------
 Loading イメージ表示関数
 引数： msg 画面に表示する文言
 ------------------------------ */
function dispLoading(msg){
  // 引数なし（メッセージなし）を許容
  if( msg == undefined ){
    msg = "";
  }
  // 画面表示メッセージ
  var dispMsg = "<div class='loadingMsg'>" + msg + "</div>";
  // ローディング画像が表示されていない場合のみ出力
  if($("#loading").length == 0){
    $("body").append("<div id='loading'>" + dispMsg + "</div>");
  }
}

/* ------------------------------
 Loading イメージ削除関数
 ------------------------------ */
function removeLoading(){
  $("#loading").remove();
}
});
